# 网络层

## 概述

![image-20210728154248903](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728154248903.png)

主要任务是把==分组==从源端传到目的端，为分组交换网上的不同主机提供通信服务。网络层传输单位是==数据报。==

==提供尽最大努力交付，不可靠传输==

- 功能一:路由选择与分组转发 <font color='red'>最佳路径</font>

- 功能二:异构网络互联

- 功能三:拥塞控制

  > 若所有结点都来不及接受分组,而要丢弃大量分组的话，网络就处于==拥塞==状态。因此要采取一定措施,缓解这种拥塞。
  >
  > - WAY1;开环控制 	静
  > - WAY2;闭环控制 	动

## IPv4

### IP数据报

#### TCP/IP协议栈

![image-20210728154520078](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728154520078.png)

#### IP数据报格式

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728155737615.png" alt="image-20210728155737615" style="zoom:80%;" />

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728155709017.png" alt="image-20210728155709017" style="zoom: 75%;" />

- **版本**:IPv4/ IPv6?

- **首部长度**:单位是==4B==，最小为==5==。

- **区分服务**:指示期望获得哪种类型的服务。

- **总长度**:首部+数据，单位是==1B==。  	最大长度为：$2^{16}-1=65535B$

- **标识**:同一数据报的分片使用同一标识。

- **标志**:只有2位有意义x _ _

  中间位DF (Don't Fragment) :
  DF=1，禁止分片
  DF=0，允许分片

  最低位MF (More Fragment)
  MF=1，后面“还有分片”<br>MF=0，代表最后一片/没分片

- **片偏移**:指出较长分组分片后,某片在原分组中的相对位置。以==8B==为单位。

- **生存时间(TTL)**:IP分组的保质期。经过一个路由器-1，变成0则丢弃。

- **协议**:数据部分的协议。

  <img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728160141095.png" alt="image-20210728160141095" style="zoom:67%;" />

- **首部检验和**:只检验首部。

- **源IP地址和目的IP地址**:32位。

- **可选字段**:0~40B ,用来支持排错、测量以及安全等措施。

- **填充**:，全0，把首部补成4B的整数倍。

#### IP数据报分片

**最大传送单元MTU**：链路层数据帧可封装数据的上限。以太网的MTU是<font color='red'>1500字节</font>。

![image-20210728163241921](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728163241921.png)

如果所传送的数据报长度超过某链路的MTU值?

<font color='red' size=5>答：分片</font>

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728155709017.png" alt="image-20210728155709017" style="zoom: 75%;" />

- **标识**:同一数据报的分片使用同一标识。

- **标志**:只有2位有意义x _ _

  中间位DF (Don't Fragment) :
  DF=1，禁止分片
  DF=0，允许分片

  最低位MF (More Fragment)
  MF=1，后面“还有分片”<br>MF=0，代表最后一片/没分片

- **片偏移**:指出较长分组分片后,某片在原分组中的相对位置。以==8B==为单位。

### IPv4地址

#### 分类的IP地址

IP地址:全世界唯一的==32位/4字节==标识符，标识路由器主机的接口。‘

IP地址::={<网络号>,<主机号>}

<font color='red'>例：11011111 00000001 00000001 00000001=223.1.1.1</font>

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728172820464.png" alt="image-20210728172820464" style="zoom:63%;" />

![image-20210728173005005](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728173005005.png)

##### 特殊的IP地址

![image-20210728171624966](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728171624966.png)

##### 私有IP地址

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210728172931503.png" alt="image-20210728172931503" style="zoom:73%;" />

###### 网络地址转换NAT

**网络地址转换NAT (Network Address Translation):**在==专用网==连接到==因特网==的路由器上安装NAT软件，安装了NAT软件的路由器叫**NAT路由器**，它至少有一个有效的**外部全球IP地址**。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210801170648934.png" alt="image-20210801170648934" style="zoom:67%;" />

#### 子网的划分

##### 子网划分

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210801171615141.png" alt="image-20210801171615141" style="zoom:67%;" />

某单位划分子网后，对外仍**表现为一个网络**，即本单位外的网络看不见本单位内子网的划分。

主机号不能全0也不能全1

##### 子网掩码

子网掩码与IP地址逐位相与，就得到子网网络地址。

##### 使用子网时分组的转发

路由器转发分组的算法:

1. 提取目的IP地址
2. 是否直接交付
3. 特定主机路由
4. 检测路由表中有无路径
5. .默认路由0.0.0.0
6. 丢弃，报告转发分组出错

#### 无分类编址CIDR

无分类域间路由选择CIDR:

1. 消除了传统的A类，B类和c类地址以及划分子网的概念。
2. 融合子网地址与子网掩码，方便子网划分。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805170403535.png" alt="image-20210805170403535" style="zoom: 80%;" />

CIDR记法:IP地址后加上“/”，然后写上网络前缀（可以任意长度）的位数。

e.g. 128.14.32.0/20

CIDR把网络前缀都相同的连续的IP地址组成一个“CIDR地址块”。

128.14.35.7/20是某CIDR地址块中的一个地址

二进制:**10000000 00001110 0010**0011 00000111

最小地址:**10000000 00001110 0010**0000 00000000 	128.14.32.0

最大地址:10000000 00001110 00101111 11111111 	128.14.47.255

地址块:128.14.32.0/20 	“/20地址块”

地址掩码（子网掩码): 11111111 11111111 1111000000000000

##### 构成超网

将多个子网聚合成一个较大的子网，叫做构成超网，或路由聚合。

方法:将网络前缀缩短（所有网络地址取交集)。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805170830215.png" alt="image-20210805170830215" style="zoom: 80%;" />

- ==划分子网是少→多==
- ==构成超网是多→少==

##### 最长前缀匹配

使用CIDR时，查找路由表可能得到几个匹配结果（跟网络掩码按位相与），应选择具有最长网络前缀的路由。前缀越长,地址块越小，路由越具体。

### ARP协议

由于在实际网络的链路上传送数据帧时，最终必须使用MAC地址。

**ARP协议**:完成主机或路由器IP地址到MAC地址的映射。 	`解决下一跳走哪的问题`

ARP协议使用过程:

检查ARP高速缓存，有对应表项则写入MAC帧，没有则用目的MAC地址为FF-FF-FF-FF-FF-FF的帧封装并==广播ARP请求分组==，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会向源主机==单播一个ARP响应分组==，源主机收到后将此映射==写入ARP缓存==（10-20min更新一次）。

ARP协议4种典型情况:

1. 主机A发给本网络上的主机B:用ARP找到主机B的硬件地址;
2. 主机A发给另一网络上的主机B:用ARP找到本网络上一个路由器(网关）的硬件地址;
3. 路由器发给本网络的主机A:用ARP找到主机A的硬件地址;
4. 路由器发给另一网络的主机B:用ARP找到本网络上的一个路由器的硬件地址

### DHCP协议

主机如何获得IP地址?

- 静态配置
- 动态配置

<font color='red'>**动态主机配置协议DHCP**</font>是==应用层==协议，使用==客户/服务器==方式，客户端和服务端通过==广播==方式进行交互，基于==UDP==。

DHCP提供即插即用联网的机制，主机可以从服务器动态获取IP地址、子网掩码、默认网关、DNS服务器名称与IP地址,允许**地址重用**，支持**移动用户加入网络**，支持在用**地址续租**。

DHCP协议流程：

1. 主机广播DHCP发现报文 	<font color='red'>“有没有DHCP服务器呀?”</font> 	试图找到网络中的服务器，服务器获得一个IP地址。
   1. ==主机发送的封装DHCP Discover报文的IP分组的源IP地址为：0.0.0.0，目的IP地址为：255.255.255.255==

2. DHCP服务器广播DHCP提供报文 	<font color='blue'>“有!”“有!”“有!”</font> 	服务器拟分配给主机一个IP地址及相关配置，先到先得。
3. 主机广播DHCP请求报文 	<font color='red'>“我用你给我的IP地址啦?”</font> 	主机向服务器请求提供IP地址,告诉其他主机已经找到其他服务器。
4. DHCP服务器广播DHCP确认报文 	<font color='blue'>“用吧!”</font> 	正式将IP地址分配给主机。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805195422701.png" alt="image-20210805195422701" style="zoom:80%;" />

### ICMP协议

网际控制报文协议ICMP

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805200931126.png" alt="image-20210805200931126" style="zoom:80%;" />

分类：

1. ICMP差错报文
2. ICMP询问报文

#### ICMP差错报告报文(5种)

1. 终点不可达:当路由器或主机不能交付数据报时就向源点发送终点不可达报文。<font color='red'>无法交付</font>
2. ~~源点抑制:当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。<font color='red'>拥塞丢数据</font>~~
3. 时间超过:当路由器收到生存时间TTL=0的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。 <font color='red'>TTL=0</font>
4. 参数问题:当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。<font color='red'>首部字段有问题</font>
5. 改变路由（重定向)﹔路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由）。<font color='red'>值得更好的路由</font>

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805201542406.png" alt="image-20210805201542406" style="zoom:67%;" />

不应发送ICMP差错报文的情况:

1. 对**ICMP差错报告报文**不再发送ICMP差错报告报文。
2. 对**第一个分片的**数据报片的所有**后续数据报片**都不发送ICMP差错报告报文。
3. 对具有**组播地址**的数据报都不发送ICMP差错报告报文。
4. 对具有**特殊地址**（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

#### ICMP询问报文

1. 回送请求和回答报文 	主机或路由器向特定目的主机发出的询问，收到此报文的主机必须给源主机或路由
   器发送ICMP回送回答报文。<font color='red'>测试目的站是否可达以及了解其相关状态。</font>
2. 时间戳请求和回答报文	 请某个主机或路由器回答当前的日期和时间。<font color='red'>用来进行时钟同步和测量时间。</font>
3. ~~掩码地址请求和回答报文~~
4. ~~路由器询问和通告报文~~

#### ICMP的应用

PING：测试两个主机之间的连通性，使用了**ICMP回送请求和回答报文。**

Traceroute：跟踪一个分组从源点到终点的路径，使用了**ICMP时间超过差错报告报文。**

## IPv6

为什么有IPv6?

- 32位IPv4地址空间已分配殆尽... 	CIDR  NAT 	治标不治本
- lPv6 	从根本上解决地址耗尽问题
- 改进首部格式
- 快速处理/转发数据报
- 支持QoS

> Qos (Quality of Service，服务质量)）指一个网络能够利用各种基础技术，为指定的网络通信提供更好的服务能力,是网络的一种安全机制，是用来解决网络延迟和阻塞等问题的一种技术。

### lPv6数据报格式

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805210410188.png" alt="image-20210805210410188" style="zoom:67%;" />

==固定<font color='red'>40B</font>基本首部==

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805211034792.png" alt="image-20210805211034792"  />

- **版本**：指明了协议版本，总是6。

- **流标签**：区分数据报的类别和优先级。

  > “流”是互联网络上从特定源点到特定终点的一系列数据报。所有属于同一个流的数据报都具有同样的流标签。

- **有效载荷长度**

- **下一个首部**：标识下一个扩展首部或上层协议首部。

- **跳数限制**：相当于IPv4的TTL。

### IPv4&IPv6

1. lPv6将地址从==32位（4B）==扩大到==128位(16B）==，更大的地址空间。
2. IPv6将IPv4的==校验和字段彻底移除==，以减少每跳的处理时间。
3. IPv6将IPv4的可选字段移出首部，变成了==扩展首部==，成为灵活的首部格式，路由器通常不对扩展首部进行检查，大大提高了路由器的处理效率。
4. lPv6支持==即插即用==(即自动配置），不需要DHCP协议。
5. lPv6首部长度必须是==8B的整数倍==，IPv4首部是==4B的整数倍==。
6. lPv6==只能在主机处分片==，IPv4可以在路由器和主机处分片。
7. ICMPv6:附加报文类型“分组过大”。
8. IPv6支持资源的预分配，支持实时视像等要求，保证一定的带宽和时延的应用。
9. IPv6取消了协议字段,改成下一个首部字段。
10. IPv6取消了总长度字段，改用有效载荷长度字段。
11. lPv6取消了服务类型字段。

### IPv6地址表示形式

一般形式冒号十六进制记法:4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170

压缩形式4BF5:0000:0000:0000:BA5F:039A:000A:2176  	→ 	4BF5:0:0:0:BA5F:39A:A:2176。

零压缩:一连串连续的0可以被一对冒号取代。

FF05:0:0:0:0:0:0:B3  	→ 	FF05::B3

<font color='red'>双冒号表示法在一个地址中仅可出现一次。</font>

### lPv6基本地址类型

- 单播:一对一通信 	可做源地址+目的地址
- 多播:一对多通信 	可做目的地址
- 任播:一对多中的一个通信 	可做目的地址

### IPv6向IPv4过渡的策略

双栈协议

双协议栈技术就是指在一台设备上**<font color='red'>同时启用IPv4协议栈和IPv6协议栈</font>**。这样的话，这台设备既能和IPv4网络通信，又能和IPv6网络通信。如果这台设备是一个==路由器==，那么这台路由器的不同接口上，分别配置了IPv4地址和IPv6地址，并很可能分别连接了IPv4网络和IPv6网络。如果这台设备是一个==计算机==，那么它将同时拥有IPv4地址和IPv6地址，并具备同时处理这两个协议地址的功能。

隧道技术

通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据（或负载)可以是不同协议的数据帧或包。隧道协议将其它协议的数据帧或包**<font color='red'>重新封装</font>**然后通过隧道发送。

## 路由协议

### 路由算法

路由算法分类:

<font color='blue'>静态路由算法</font>(非自适应路由算法）

- 管理员手工配置路由信息。
- <font color='green'>简便、可靠,在负荷稳定、拓扑变化不大的网络中运行效果很好，广泛用于高度安全性的军事网络和较小的商业网络。</font>
- <font color='brown'>路由更新慢，不适用大型网络。</font>

<font color='blue'>动态路由算法</font>(自适应路由算法)

* 路由器间彼此交换信息，按照路由算法优化出路由表项。
* <font color='green'>路由更新快，活用大型网络，及时响应链路费用或网络拓扑峦化.</font>
* <font color='brown'>算法复杂,增加网络负担。</font>

动态路由算法:

全局性 	链路状态路由算法 	OSPF

* 所有路由器掌握完整的网络拓扑和链路费用信息。

分散性 	距离向量路由算法 	RIP

* 路由器只掌握物理相连的邻居及链路费用。

### 分层次的路由选择协议

分层次的原因：

1. 因特网规模很大
2. 许多单位不想让外界知道自己的路由选择协议，但还想连入因特网

> **==自治系统AS==**:在单一的技术管理下的一组路由器，而这些路由器使用一种AS内部的路由选择协议和共同的度量以确定分组在该AS内的路由，同时还使用一种AS之间的路由协议以确定在AS之间的路由。
>
> 一个AS内的所有网络都属于一个行政单位来管辖，一个自治系统的所有路由器在本自治系统内都必须连通。

分类：

- 内部网关协议IGP 	一个AS内使用的 	例：RIP、OSPF
- 外部网关协议EGP 	AS之间使用的 	例：BGP

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805222221258.png" alt="image-20210805222221258" style="zoom: 80%;" />

### RIP协议与距离向量算法

#### RIP协议

RIP是一种分布式的基于==距离向量==的路由选择协议，是因特网的协议标准，最大优点是**简单**。

RIP协议要求网络中每一个路由器都维护从**它自己到其他每一个目的网络的唯一最佳距离记录**（即一组距离)。

距离:通常为“跳数”，即从源端口到目的端口所经过的路由器个数，经过一个路由器跳数+1。特别的，从一路由器到直接连接的网络距离为1。RIP允许一条路由最多只能包含15个路由器，因此距离为<font color='red'>16表示网络不可达。</font>

RIP是==应用层协议==,使用<font color='red'>UDP</font>传送数据。

RIP的特点:当网络出现故障时，要经过比较长的时间(例如数分钟)才能将此信息传送到所有的路由器，“慢收敛”。<font color='blue'>(RIP协议好消息传得快,坏消息传得慢)</font>

**==RIP协议只适用于小互联网。==**

问：RIP协议和谁交换?

答：仅和<font color='red'>相邻路由器</font>交换信息。

多久交换一次?

<font color='red'>每30秒</font>交换一次路由信息，然后路由器根据新信息更新路由表。若超过180s没收到邻居路由器的通告，则判定邻居没了，并更新自己路由表。

交换什么?

路由器交换的信息是<font color='red'>自己的路由表</font>。

路由器刚开始工作时，只知道直接连接的网络的距离（距离为1)，接着每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。

经过若干次更新后，所有路由器最终都会知道到达本自治系统任何一个网络的最短距离和下一跳路由器的地址，即“**收敛**”。

#### 距离向量算法

1. 修改相邻路由器发来的RIP报文中所有表项
   对地址为x的相邻路由器发来的RIP报文，修改此报文中的所有项目:把“下一跳”字段中的地址改为X，并把所有的“距离”字段+1。

2. 对修改后的RIP报文中的每一个项目，进行以下步骤:

   1. R1路由表中若没有Net3，则把该项目填入R1路由表

   2. R1路由表中若有Net3，则查看下一跳路由器地址;

      若下一跳是x，则用收到的项目替换源路由表中的项目;

      若下一跳不是x，原来距离比从x走的距离远则更新，否则不作处理。

3. 若180s还没收到相邻路由器x的更新路由表，则把x记为不可达的路由器，即把距离设置为16.

4. 返回

#### RIP协议的报文格式

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210806223214535.png" alt="image-20210806223214535" style="zoom: 67%;" />

RIP是==应用层协议==,使用<font color='red'>UDP</font>传送数据。

一个RIP报文最多可包括25个路由，如超过，必须再用-个RIP报文传送。

### OSPF协议与链路状态算法

#### OSPF协议

开放最短路径优先OSPF协议:“开放”标明OSPF协议不是受某一家厂商控制，而是**公开发表**的;“最短路径优先”是因为使用了**Dijkstra**提出的**最短路径算法SPF。**

OSPF最主要的特征就是使用分布式的**链路状态协议**。

OSPF直接用<font color='red'>IP数据报</font>传送。

和谁交换?

答：使用洪泛法向自治系统内所有路由器发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器。<font color='red'>广播</font>

最终整个区域内所有路由器都得到了这个信息的一个副本。

交换什么?

发送的信息就是与本路由器**相邻的所有路由器的链路状态**（本路由器和哪些路由器相邻，以及该链路的度量/代价――费用、距离、时延、带宽等）。

多久交换?

只有当**链路状态发生变化时**，路由器才向所有路由器洪泛发送此信息。

最后，所有路由器都能建立一个**链路状态数据库**，即**全网拓扑图**。



特点：

每隔**30min**，要刷新一次数据库中的链路状态。

由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当==互联网规模很大==时，OSPF协议要比距离向量协议RIP好得多。

OSPF不存在坏消息传的慢的问题，它的==收敛速度很快==。

#### 链路状态路由算法

1. 每个路由器发现它的邻居结点【HELLO问候分组】，并了解邻居节点的网络地址。
2. 设置到它的每个邻居的成本度量metric。
3. 构造【DD数据库描述分组】，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
4. 如果DD分组中的摘要自己都有，则邻站不做处理;如果有没有的或者是更新的，则发送【LSR链路状态请求分组】请求自己没有的和比自己更新的信息。
5. 收到邻站的LSR分组后，发送【LSU链路状态更新分组】进行更新。
6. 更新完毕后，邻站返回一个【LSAck链路状态确认分组】进行确认。只要一个路由器的链路状态发生变化:
7. 泛洪发送【LSU链路状态更新分组】进行更新。
8. 更新完毕后，其他站返回一个【LSAck链路状态确认分组】进行确认。
9. 使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径。

#### OSPF的区域

为了使OSPF能够用于规模很大的网络，OSPF将一个自治系统再划分为若干个更小的范围，叫做区域。每一个区域都有一个32位的区域标识符（用点分十进制表示）。

区域也不能太大，在一个区域内的路由器最好不超过200个。至其他自治系统

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210806224051462.png" alt="image-20210806224051462" style="zoom: 67%;" />

#### OSPF分组

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210806224133466.png" alt="image-20210806224133466" style="zoom:67%;" />

OSPF直接用<font color='red'>IP数据报</font>传送。

### BGP协议

#### BGP协议

和谁交换?

答：与其他AS的邻站BGP发言人交换信息。

交换什么?

答：交换的网络可达性的信息，即要到达某个网络所要经过的一系列AS。

多久交换?

答：发生变化时更新有变化的部分。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210806224419614.png" alt="image-20210806224419614" style="zoom: 67%;" />

#### BGP协议交换信息的过程

BGP所交换的网络可达性的信息就是要==到达某个网络所要经过的一系列AS==。当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就根据所采用的策略从收到的路由信息中找出到达各AS的较好路由。

#### BGP协议报文格式

一个BGP发言人与其他自治系统中的BGP发言人要交换路由信息，就要**先建立TCP连接**，即通过TCP传送，然后在此连接上交换BGP报文以建立BGP会话(session)，利用BGP会话交换路由信息。

![image-20210806224633282](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210806224633282.png)

#### BGP协议特点

BGP支持==CIDR==，因此BGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。

在BGP刚刚运行时，BGP的邻站是交换整个的BGP路由表。但以后只需要在==发生变化时更新有变化的部分==。这样做对节省网络带宽和减少路由器的处理开销都有好处。

#### BGP-4的四种报文

1.OPEN(打开）报文:用来与相邻的另一个BGP发言人建立关系，并认证发送方。

2.UPDATE（更新）报文:通告新路径或撤销原路径。

3.KEEPALIVE（保活）报文:在无UPDATE时，周期性证实邻站的连通性;也作为OPEN的确认

4.NOTIFICATION(通知）报文:报告先前报文的差错;也被用于关闭连接。

### 三种协议的比较

RIP是一种分布式的基于距离向量的内部网关路由选择协议，通过广播UDP报文来交换路由信息。

OSPF是一个内部网关协议，要交换的信息量较大，应使报文的长度尽量短，所以不使用传输层协议（如UDP或TCP)，而是直接采用IP。

BGP是一个外部网关协议，在不同的自治系统之间交换路由信息，由于网络环境复杂，需要保证可靠传输，所以采用TCP。

![image-20210806224843785](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210806224843785.png)

## 组播

### IP数据报的三种传输方式

1. 单播<br>单播用于发送数据包到单个目的地,且每发送一份单播报文都使用一个单播IP地址作为目的地址。是一种==点对点==传输方式。
2. 广播<br>广播是指发送数据包到同一广播域或子网内的所有设备的一种数据传输方式,是一种==点对多点==传输方式。
3. 组播（多播）<br>当网络中的某些用户需要特定数据时,组播数据发送者仅发送一次数据，借助组播路由协议为组播数据包建立组播分发树，被传递的数据到达距离用户端尽可能近的节点后才开始复制和分发，是一种==点对多点==传输方式。



<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809174250137.png" alt="image-20210809174250137" style="zoom:67%;" />

组播提高了数据传送效率。减少了主干网出现拥塞的可能性。组播组中的主机可以是在同一个物理网络，也可以来自不同的物理网络（如果有**组播路由器**的支持）。

> **组播路由器:运行组播协议的路由器**

### IP组播地址

IP组播地址让源设备能够将分组发送给一组设备。属于多播组的设备将被分配一个组播组IP地址（一群共同需求主机的相同标识）。

组播地址范围为**224.0.0.0~239.255.255.255(D类地址)**，一个D类地址表示一个组播组。只能用作分组的==目标地址==。**源地址**总是为**单播地址**。

特点：

1. 组播数据报也是“尽最大努力交付”，不提供可靠交付，应用于UDP。
2. 对组播数据报不产生ICMP差错报文。
3. 并非所有D类地址都可以作为组播地址。

分类：

* 因特网范围内组播
* 硬件组播

### 硬件组播

同单播地址一样，组播IP地址也需要相应的组播MAC地址在本地网络中实际传送帧。组播MAC地址以十六进制值01-00-5E打头，余下的6个十六进制位是根据IP组播组地址的最后23位转换得到的

TCP/IP协议使用的以太网多播地址的范围是:从<font color='red'>01-00-5E-00-00-00</font>到<font color='red'>01-00-5E-7F-FF-FF</font> .

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809175136412.png" alt="image-20210809175136412" style="zoom:67%;" />

因为IP地址有5位不在MAC地址中出现，所以会出现两个IP地址为同一个MAC地址的问题。所以：**收到多播数据报的主机，还要在IP层利用软件进行过滤，把不是本主机要接收的数据报丢弃。**

### 网际组管理协议IGMP

**lGMP协议让路由器知道本局域网上是否有主机(的进程)参加或退出了某个组播组。**

IGMP和ICMP相同，都使用**==IP数据报==**传递报文。

IGMP工作的两个阶段：

1. 某主机要加入组播组时，该主机向组播组的组播地址发送一个IGMP报文，声明自己要称为该组的成员。
   本地组播路由器收到IGMP报文后，要利用==组播路由选择协议==把这组成员关系发给因特网上的其他组播路由器。
2. 本地组播路由器周期性探询本地局域网上的主机，以便知道这些主机是否还是组播组的成员。
   只要有一个主机对某个组响应，那么组播路由器就认为这个组是活跃的;如果经过几次探询后没有一个主机响应，组播路由器就认为本网络上的没有此组播组的主机，因此就不再把这组的成员关系发给其他的组播路由器。

### 组播路由选择协议

组播路由协议目的是找出以源主机为根节点的**组播转发树**。

构造树可以避免在路由器之间兜圈子。

对不同的多播组对应于不同的多播转发树;同一个多播组，对不同的源点也会有不同的多播转发树。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809175757295.png" alt="image-20210809175757295" style="zoom:67%;" />

组播路由选择协议常使用的三种算法:

1. 基于链路状态的路由选择
2. 基于距离-向量的路由选择
3. 协议无关的组播（稀疏/密集)

## 移动IP

### 移动IP相关概念

移动IP技术是移动结点(计算机/服务器等)以固定的网络IP地址，实现跨越不同网段的漫游功能，并保证了基于网络IP的网络权限在漫游过程中不发生任何改变。

<font color='blue'>移动结点</font> 	具有永久IP地址的移动设备。

<font color='blue'>归属代理（本地代理）</font>	一个移动结点的永久“居所”称为归属网络，在归属网络中代表移动节点执行移

动管理功能的实体叫做归属代理。

<font color='blue'>永久地址（归属地址/主地址）</font> 	移动站点在归属网络中的原始地址。

<font color='blue'>外部代理（外地代理）</font> 	在外部网络中帮助移动节点完成移动管理功能的实体称为外部代理。

<font color='blue'>转交地址（辅地址）</font>	可以是外部代理的地址或动态配置的一个地址。

### 移动IP通信过程

![image-20210809180324498](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809180324498.png)

A刚进入外部网络：

1. 获得外部代理的转交地址(外部代理广播报文)。
2. 移动节点通过外部代理发送注册报文给归属代理（包含永久地址&转交地址）。
3. 归属代理接收请求，并将移动节点的永久地址和转交地址绑定（以后到达该归属代理的数据报且要发往移动节点的数据报将被封装并以隧道方式发给转交地址），并返回一注册响应报文。
4. 外部代理接收注册响应，并转发给移动节点。

A移动到了下一个网络：

1. 在新外部代理登记注册一个转交地址。
2. 新外部代理给本地代理发送新的转交地址（覆盖旧的)
3. 通信

A回到了归属网络：

1. A向本地代理注销转交地址。
2. 按原始方式通信。

## 网络层设备

### 路由器

路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组。

![image-20210809180823751](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809180823751.png)

路由表根据路由选择算法得出的，主要用途是路由选择，总用软件来实现。

转发表由**路由表**得来，可以用软件实现，也可以用特殊的硬件来实现。转发表必须包含完成转发功能所必需的信息，在转发表的每一行必须包含从要到达的目的网络到输出端口和某些MAC地址信息的映射。

![image-20210809180938825](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809180938825.png)

![image-20210809180947207](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809180947207.png)

<font size='5' color='red'>**路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。**</font>

### SDN基本概念

路由器功能：**路由选择&转发**

转发:达到路由器输入链路之一的数据报如何转发到该路由器的输出链路之一。**时间短，通常硬件解决。**

路由选择:控制数据报沿着从源主机到目的主机的端到端路径中路由器之间的路由方式。**时间长，通常软件解决。**

------

#### 数据平面

数据平面对于数据处理过程中各种具体处理转发过程。

数据平面执行的主要功能是==根据转发表进行转发==，这是路由器的本地动作。



#### 控制平面

控制平面用于控制和管理网络协议的运行，比如OSPF协议、RIP协议、BGP协议。

##### 传统方法（每路由器法）

路由选择算法运行在每台路由器中，并且在每台路由器中都包含转发和路由选择两种功能。

实现方法：**在一台路由器中的路由选择算法与其他路由器中的路由选择算法通信（通过交换路由选择报文)，计算出路由表和转发表。**

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127152338288.png" alt="image-20211127152338288" style="zoom:80%;" />

##### SDN法

**控制平面从路由器物理上分离**。路由器仅实现**转发**，远程控制器计算和分发转发表以供每台路由器所使用。

路由器通过交换包含转发表和其他路由选择信息的报文与远程控制器通信。因为计算转发并与路由器交互的控制器是用软件实现的，所以网络是“软件定义的"。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127152447744.png" alt="image-20211127152447744" style="zoom:80%;" />

### 路由选择处理机

* 传统方法:
  路由选择处理器执行控制平面功能。在传统的路由器中，它执行路由选择协议，维护路由选择表于关联链路状态信息，并为该路由器计算转发表。
* SDN方法:
  在SDN路由器中，路由选择处理器负责与远程控制器通信，目的是接收远程控制器计算的转发表项。==（地位下降）==

### SDN控制平面

1. **SDN控制器**:维护准确的网络状态信息(远程链路、交换机和主机的状态)；为运行在控制平面中的网络控制应用程序提供这些信息（逻辑集中，在多台服务器上实现)。
2. **网络控制应用程序**:根据SDN控制器提供的方法，这些应用程序通过这些方法能够监视、编程和控制下面的网络设备。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127152928662.png" alt="image-20211127152928662" style="zoom:80%;" />

#### SDN控制器的三层

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127153243080.png" alt="image-20211127153243080" style="zoom:80%;" />

##### 对于网络控制应用程序的接口

SDN控制器通过“北向接口”与网络控制应用程序交互。该API允许网络控制应用程序在状态管理层之间读写网络状态。

##### 网络范围状态管理层

由SDN控制平面作出的最终控制决定,将要求控制器具有有关网络的主机、链路等最新状态信息。

##### 通信层

SDN控制器与受控网络设备之间的通信(OpenFlow协议)，包含"南向接口”

### 三层设备的区别

- 路由器可以互联两个不同网络层协议的网段。
- 网桥可以互联两个物理层和链路层不同的网段。
- 集线器**==不能==**互联两个物理层不同的网段。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210809181238939.png" alt="image-20210809181238939" style="zoom:80%;" />

