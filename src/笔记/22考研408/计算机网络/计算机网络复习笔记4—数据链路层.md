# 数据连路层

## 概述

### 基本概念

- 节点：主机、路由器
- 链路：网络中两个节点之间的==物理通道==，链路的传输介质主要有双绞线、光纤和微波。分为有线链路、无线链路。
- 数据链路：网络中两个结点之间的==逻辑通道==，把实现控制数据传输协议的硬件和软件加到链路上就构成数据链路。
- 帧：链路层的协议数据单元，封装网络层数据报。

==数据链路层：负责通过一条链路从一个结点向另一个物理链路直接相连的相邻结点传送数据报。==

### 功能概念

数据链路层在物理层提供服务的基础上==向网络层提供服务==，其最基本的服务是将源自网络层来的数据==可靠==地传输到相邻节点的目标机网络层。其主要作用是==加强物理层传输原始比特流的功能==，将物理层提供的可能出错的物理连接改造成为==逻辑上无差错的数据链路==，使之对网络层表现为一条无差错的链路。

* 功能一：为网络层提供服务。==无确认无连接服务，有确认无连接服务，有确认面向连接服务==。
* 功能二：决链路管理，即连接的建立、维持、释放（用于面向连接的服务）。
* 功能三：组帧
* 功能四：流量控制
* 功能五：差错控制（帧错/位错）。

## 封装成帧和透明传输

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720155825011.png" alt="image-20210720155825011" style="zoom:67%;" />

==封装成帧==就是在一段数据的前后部分添加首部和尾部，这样就构成了一个帧。接收端在收到物理层上交的比特流后，就能根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束。

==透明传输==是指不管所传数据是什么样的比特组合，都应当能够在链路上传送。因此，链路层就“看不见”有什么妨碍数据传输的东西。

当所传数据中的比特组合恰巧与某一个控制信息完全一样时，就必须采取适当的措施，使收方不会将这样的数据误认为是某种控制信息。这样才能保证数据链路层的传输是透明的。

==帧同步==：接收方应当能从接收到的二进制比特流中区分出帧的起始和终止。

#### 组帧的四种方法

##### 字符计数法

帧首部使用一个计数字段（第一个**字节**，八位）来标明帧内字符数。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720160152491.png" alt="image-20210720160152491" style="zoom:67%;" />

痛点：当一个计数字段出错时，后边的帧可能全部发生错误。

##### 字符（节）填充法



当传送的帧是由文本文件组成时（文本文件的字符都是从键盘上输入的，都是ASCII码）。不管从键盘上输入什么字符都可以放在帧里传过去，即==透明传输==。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720160436482.png" alt="image-20210720160436482" style="zoom:80%;" />

当传送的帧是由非ASCII码的文本文件组成时（二进制代码的程序或图像等）。就要采用==字符填充方法实现透明传输。==

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720160344033.png" alt="image-20210720160344033" style="zoom:80%;" />



##### 零比特填充法

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720160953571.png" alt="image-20210720160953571" style="zoom:80%;" />

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720161017743.png" alt="image-20210720161017743" style="zoom:80%;" />

**==保证了透明传输:在传送的比特流中可以传送任意比特组合，而不会引起对帧边界的判断错误。==**

##### 违规编码法

![image-20210720161106779](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720161106779.png)

由于字节计数法中Count字段的脆弱性（其值若有差错将导致灾难性后果)及字符填充实现上的复杂性和不兼容性，目前较普遍使用的帧同步法是**比特填充**和**违规编码法**。

## 差错控制(检错编码)

### 差错原因

概括来说，传输中的差错都是由于噪声引起的==（随机差错）==

全局性 	由于线路本身电气特性所产生的随机噪声(热噪声)，是信道固有的，随机存在的。
解决办法:提高信噪比来减少或避免干扰。(对传感器下手)

局部性 	外界特定的短暂原因所造成的冲击噪声，是产生差错的主要原因。
解决办法:通常利用编码技术来解决。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720163656420.png" alt="image-20210720163656420" style="zoom: 67%;" />

### 差错控制

> 编码VS编码
>
> 数据链路层编码和物理层的数据编码与调制==不同==。物理层编码针对的是**单个比特**，解决传输过程中比特的同步等问题,如曼彻斯特编码。而数据链路层的编码针对的是**一组比特**,它通过冗余码的技术实现一组二进制比特串在传输过程是否出现了差错。
>
> 冗余编码
>
> 在数据发送之前，先按某种关系**附加**上一定的==冗余位==，构成一个符合某一规则的码字后再发送。当要发送的有效数据变化时，相应的冗余位也随之变化，使码字遵从不变的规则。接收端根据收到码字是否仍符合原规则，从而判断是否出错。

#### 检错编码

##### 奇偶校验码

n-1位信息元，1位校验元

奇校验：“1”的个数为**奇数**

偶校验：“1”的个数为**偶数**

奇偶校验码特点:只能检查出奇数个比特错误，检错能力为50%。

![image-20210720164230157](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720164230157.png)

正确答案：D

##### CRC循环冗余码

![image-20210720164529671](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720164529671.png)

![image-20210720164432155](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720164432155.png)



例:要发送的数据是1101011011，采用CRC校验，生成多项式是10011，那么最终发送的数据应该是?

计算冗余码：

1. **加0** 	`假设生成多项式G(x)的阶数为r，则加r个0` 由题可知10011为X^4^+X+1 阶数为4
2. **模2除法** 	`数据加0后除以多项式，余数为冗余码(FCS)` 由题可知数据加0后为11010110110000
3. <img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720165227894.png" alt="image-20210720165227894" style="zoom:67%;" /> 

接收端检错过程

把收到的每一个帧都除以同样的除数，然后检查得到的余数R。

1. 余数为0，判定这个帧没有差错，==接受==。
2. 余数为不为0，判定这个帧有差错（无法确定到位)，==丢弃==。

FCS的生成以及接收端CRC检验都是由硬件实现，处理很迅速，因此不会延误数据的传输。

> 在数据链路层仅仅使用循环冗余检验CRC差错检测技术，只能做到对帧的无差错接收，即“凡是接收端数据链路层接受的帧，我们都能以非常接近于1的概率认为这些帧在传输过程中没有产生差错”。接收端丢弃的帧虽然曾收到了，但是最终还是因为有差错被丢弃。“凡是接收端数据链路层接收的帧均无差错”。
>
> “可靠传输”:数据链路层发送端发送什么，接收端就收到什么。
>
> ==链路层使用CRC检验==，能够实现无比特差错的传输，但这还==不是可靠传输。==



#### 纠错编码

##### 海明码

工作流程：

1. 确定校验码位数
2. 确定校验码和数据的位置
3. 求出校验码的值
4. 检错纠错

###### 海明距离

两个合法编码(码字)的对应比特取值不同的比特数称为这两个码字的==海明距离(码距)==,一个有效编码集中,任
意两个合法编码(码字)的海明距离的最小值称为该编码集的==海明距离(码距)==。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720172144563.png" alt="image-20210720172144563" style="zoom:50%;" /><img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720172207150.png" alt="image-20210720172207150" style="zoom:50%;" />

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211103182836546.png" alt="image-20211103182836546" style="zoom:80%;" />

###### 确定校验码位数r

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720172254431.png" alt="image-20210720172254431" style="zoom: 67%;" />

**要发送的数据:D=1100**

数据的位数m=4,

满足不等式的最小r为3,

也就是D=1100的海明码应该有4+3=7位,其中原数据4位，校验码3位。

###### 确定校验码和数据的位置

**D=1100**
校验码放在序号为**2^n^**的位置，数据按序填上

|                |      |      |      | 1**  |      | \*1\* | **1  |
| -------------- | ---- | ---- | ---- | ---- | ---- | ----- | ---- |
| **二进制序号** | 111  | 110  | 101  | 100  | 011  | 010   | 001  |
| **序号**       | 7    | 6    | 5    | 4    | 3    | 2     | 1    |
| **值**         | 1    | 1    | 0    | X~4~ | 0    | X~2~  | X~1~ |

4号校验码负责4，5，6，7的校验

2号校验码负责2，3，6，7的校验

1号校验码负责1，3，5，7的校验

###### 求出校验码的值

**采用偶校验**

X~4~=0，X~2~=0，X~1~=1

完整海明码：

| 序号   | 7    | 6    | 5    | 4     | 3    | 2     | 1     |
| ------ | ---- | ---- | ---- | ----- | ---- | ----- | ----- |
| **值** | 1    | 1    | 0    | ==0== | 0    | ==0== | ==1== |

###### 检错纠错

若接收方收到的数据为1110001，检错类似奇偶校验

| 序号   | 7    | 6    | 5    | 4     | 3    | 2     | 1     |
| ------ | ---- | ---- | ---- | ----- | ---- | ----- | ----- |
| **值** | 1    | 1    | 1    | ==0== | 0    | ==0== | ==1== |

纠错方法：<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210720214536201.png" alt="image-20210720214536201" style="zoom:67%;" />

## 流量控制与可靠传输机制

**可靠传输:发送端发啥，接收端收啥。**

**流量控制:控制发送速率，使接收方有足够的缓冲空间来接收每一个帧。**

==较高的发送速度==和==较低的接收能力==的不匹配，会造成传输出错，因此流量控制也是数据链路层的一项重要工作

数据链路层的流量控制是点对点的，而传输层的流量控制是端到端的。

==数据链路层流量控制手段:接收方收不下就不回复确认。==

方法：

1. 停止-等待协议：**发送窗口大小=1，接受窗口大小=1**
2. 滑动窗口协议
   1. 后退N帧协议(GBN)：**发送窗口大小>1，就收窗口大小=1**
   2. 选择重传协议(SR)：**发送窗口大小>1,接受窗口大小>1**

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210722161241980.png" alt="image-20210722161241980"  />

### 停止-等待协议

除了**比特出差错**,底层信道还会出现丢包问题。为了实现流量控制。

==“停止-等待”==就是每发送完一个分组就停止发送，等待对方确认，在收到确认后再发送下一个分组。

#### 应用情况

##### 无差错情况

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210722161552010.png" alt="image-20210722161552010" style="zoom:80%;" />

##### 数据帧丢失或检测到帧出错

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210722161703017.png" alt="image-20210722161703017" style="zoom:%;" />

##### ACK丢失

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210722161818487.png" alt="image-20210722161818487"  />

##### ACK迟到

![image-20210722161917202](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210722161917202.png)

#### 性能分析

**==信道利用率太低==**

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210722162051256.png" alt="image-20210722162051256" style="zoom:80%;" />

> 信道利用率：发送方在一个发送周期内,有效地==发送数据所需要的时间==占整个==发送周期==的比率。
>
> 发送周期：从开始发送数据,到收到第一个确认帧为止
>
> ==信道吞吐率=信道利用率*发送方的发送速率==

### 后退N帧协议(GBN)

#### GBN发送方

一、上层的调用

上层要发送数据时，发送方先检查发送窗口是否已满，如果未满，则产生一个帧并将其发送;如果窗口已满,发送方只需将数据返回给上层，暗示上层窗口已满。上层等一会再发送。(实际实现中，发送方可以缓存这些数据，窗口不满时再发送帧)。

二、收到一个ACK

GBN协议中，对n号帧的确认采用**==累积确认==**的方式，标明接收方已经收到n号帧和它之前的全部帧。

三、超时事件

协议的名字为后退N帧/回退N帧，来源于出现丢失和时延过长帧时发送方的行为。就像在停等协议中一样，定时器将再次用于恢复数据帧或确认帧的丢失。如果出现超时，发送方重传所有己发送但未被确认的帧。

#### GBN接受方

一、如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ACK，并将该帧中的数据部分交付给上层。

二、其余情况都丢弃帧，并为最近按序接收的帧重新发送ACK。接收方无需缓存任何失序帧，只需要维护一个信息:expectedseqnum(下一个按序接收的帧序号）。

#### 滑动窗口长度

若采用n个比特对帧编号，那么发送窗口的尺寸W,应满足: 
$$
1≤W_T<2^n-1。
$$
因为发送窗口尺寸过大，就会使得接收方无法区别新帧和旧帧。

#### 重点

1. 累积确认（偶尔捎带确认)
2. 接收方只按顺序接收帧,不按序无情丢弃
3. 确认序列号最大的、按序到达的帧
4. 发送窗口最大为2^n^-1，接收窗口大小为1

#### 性能分析

因连续发送数据帧而提高了信道利用率

在重传时必须把原来已经正确传送的数据帧重传，是传送效率降低

### 选择重传协议(SR)

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210722163450475.png" alt="image-20210722163450475" style="zoom:67%;" />

#### SR发送方

一、上层的调用
从上层收到数据后，SR发送方检查下一个可用于该帧的序号，如果序号位于发送窗口内，则发送数据帧;否则就像GBN一样，要么将数据缓存，要么返回给上层之后再传输。

二、收到了一个ACK
如果收到ACK，加入该帧序号在窗口内，则SR发送方将那个被确认的帧标记为已接收。如果该帧序号是窗口的下界（最左边第一个窗口对应的序号)，则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内的未发送帧,则发送这些帧。

三、超时事件
每个帧都有自己的定时器，一个超时事件发生后**只重传一个帧。**

#### SR接受方

来者不拒(窗口内的帧)
SR接收方将**确认一个正确接收的帧**而<font color='orange'>不管其是否按序</font>。失序的帧将被**<font color='orange'>缓存</font>**，并返回给发送方一个该帧的确认帧**【收谁确认谁】**，直到所有帧(即序号更小的帧）皆被收到为止，这时才可以将一批帧按序交付给上层，然后**向前移动滑动窗口。**

如果收到了窗口序号外(小于窗口下界)的帧，就返回一个ACK。其他情况忽略该帧

#### 滑动窗口长度

发送窗口最好等于接收窗口。(大了会溢出，小了没意义)
$$
W_{Tmax}=W_{Rmax}=2^{(n-1)}
$$


#### 重点

1. 对数据帧逐一确认,收一个确认一个
2. 只重传出错帧
3. 接收方有缓存
4. W~Tmax~=W~Rmax~=2^(n-1)^

## 介质访问控制

**介质访问控制**的内容就是，采取一定的措施，使得两对节点之间的通信不会发生互相干扰的情况。

> 传输数据使用的两种链路
>
> 点对点链路
> 两个相邻节点通过一个链路相连，没有第三者。应用:PPP协议，常用于==广域网==。
>
> 广播式链路所有主机共享通信介质。
> 应用:早期的总线以太网、无线局域网，常用于==局域网==。

### 静态划分信道——信道划分介质访问控制

信道划分介质访问控制:将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，把==时域和频域资源==合理地分配给网络上的设备。

> 多路复用技术
> 把多个信号组合在一条物理信道上进行传输，使得多个计算机或终端设备==共享信道资源==,提高信道利用率。
>
> <img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210723202224997.png" alt="image-20210723202224997" style="zoom: 80%;" />
>
> 把一条广播信道，逻辑上分成几条用于两个节点之间通信的互不干扰的子信道,==实际就是把广播信道转变为点对点信道。==

#### 频分多路复用FDM

用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。**频分复用的所有用户在同样的时间占用不同的带宽（频率带宽）资源。**

优点：

* 充分利用传输介质带宽，系统效率较高
* 由于技术比较成熟，实现也比较容易。

#### 时分多路复用TDM

将时间划分为一段段等长的时分复用帧(TDM帧）。每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙，所有用户轮流占用信道。

改进的时分复用——统计时分复用STDM

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210723202812303.png" alt="image-20210723202812303" style="zoom:67%;" />

每一个STDM帧中的时隙数小于连接在集中器上的用户数。各用户有了数据就随时发往集中器的输入缓存，然后集中器按顺序依次扫描输入缓存，把缓存中的输入数据放入STDM帧中，一个STDM帧满了就发出。==<font color='red'>**STDM帧不是固定分配时隙,而是按需动态分配时隙。**</font>==

#### 波分多路复用WDM

波分多路复用就是**光的频分多路复用**，在一根光纤中传输多种不同波长（频率）的光信号，由于波长（频率)不同，所以各路光信号互不干扰，最后再用波长分解复用器将各路波长分解出来。

#### 码分多路复用CDM

码分多址(CDMA）是码分复用的一种方式。

1个比特分为多个码片/芯片（chip），每一个站点被指定一个唯一的m位的芯片序列,发送1时发送芯片序列（(通常把0写成-1）。

**==发送1时站点发送芯片序列，发送0时发送芯片序列反码。==**

步骤：

1. 多个站点同时发送数据的时候，要求各个站点==芯片序列相互正交==，**规格化内积为0**。
2. 两个向量到了公共信道上，**线性相加**。
3. 数据分离:合并的数据和源站规格化内积。

### 动态分配信道

#### 轮询访问介质访问控制

##### 轮询协议

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727153205187.png" alt="image-20210727153205187" style="zoom:80%;" />

问题:

1. 轮询开销
2. 等待延迟
3. 单点故障

##### 令牌传递协议

==令牌==:一个特殊格式的MAC控制帧，不含任何信息。控制信道的使用，确保同一时刻只有一个结点独占信道。

每个结点都可以在一定的时间内（令牌持有时间）获得发送数据的权利，并不是无限制地持有令牌。

问题:

1. 令牌开销
2. 等待延迟
3. 单点故障

**应用于令牌环网（物理星型拓扑，逻辑环形拓扑）。**

**采用令牌传送方式的网络常用于==负载较重、通信量较大==的网络中。**

#### ==随机访问介质访问控制：冲突==

##### ALOHA协议

###### 纯ALOHA协议

纯ALOHA协议思想:不监听信道，不按时间槽发送，随机重发。<font color='red'>想发就发</font>

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210723203704016.png" alt="image-20210723203704016" style="zoom:67%;" />

<font color='blue'>冲突如何检测?</font>

如果发生冲突，接收方在就会检测出差错,然后不予确认,发送方在一定时间内收不到确认就判断发生冲突。

超时后等一段时间再重传

###### 时隙ALOHA协议

时隙ALOHA协议的思想:把时间分成若干个相同的时间片，所有用户在时间片开始时刻同步接入网络信道,若发生冲突,则必须等到下一个时间片开始时刻再发送。<font color='red'>控制想发就发的随意性</font>

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210723204048025.png" alt="image-20210723204048025" style="zoom:80%;" />

###### 总结

1. 纯ALOHA比时隙ALOHA吞吐量更低，效率更低。
2. 纯ALOHA想发就发，时隙ALOHA只有在时间片段开始时才能发。

##### CSMA协议

<font color='blue' >载波监听多路访问协议CSMA (carrier sense multiple access)</font>

CS:载波侦听/监听，每一个站在发送数据之前要检测一下总线上是否有其他计算机在发送数据。

MA:多点接入，表示许多计算机以多点接入的方式连接在一根总线上。

==协议思想:发送帧之前,监听信道。==

监听结果：

* 信道空闲：发送完整帧
* 信道忙：推迟发送

![image-20210723222720022](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210723222720022.png)

###### 1-坚持CSMA

坚持指的是对于监听信道**==忙==**之后的坚持。

1-坚持CSMA思想:

* 如果一个主机要发送消息，那么它先监听信道。
* <font color='green'>空闲则直接传输，不必等待</font>
* <font color='red'>忙则一直监听，直到空闲马上传输</font>
* 如果有冲突(一段时间内未收到肯定回复)，则等待一个随机长的时间再监听，重复上述过程。

优点：只要媒体空闲，站点就马上发送，避免了媒体利用率的损失

缺点：假如有两个或两个以上的站点有数据要发送，冲突就不可避免。

###### 非坚持CSMA

非坚持指的是对于监听信道**==忙==**之后就不继续监听。

非坚持CSMA思想:

* 如果一个主机要发送消息，那么它先监听信道。
* <font color='green'>空闲则直接传输，不必等待。</font>
* <font color='red'>忙则等待一个随机的时间之后再进行监听。</font>

优点：采用随机的重发延迟时间可以减少冲突发生的可能性。

缺点：可能存在大家都在延迟等待过程中，使得媒体仍可能处于空闲状态，媒体使用率降低。

###### p-坚持CSMA

p-坚持指的是对于监听信道空闲的处理。

p-坚持CSMA思想:

- 如果一个主机要发送消息，那么它先监听信道。
- <font color='green'>空闲则以p概率直接传输，不必等待;概率1-p等待到下一个时间槽再传输。</font>
- <font color='red'>忙则持续监听直到信道空闲再以p概率发送。</font>
- <font color='blue'>若冲突则等到下一个时间槽开始再监听并重复上述过程。</font>

优点：既能像非坚持算法那样减少冲突，又能像1-坚持算法那样减少媒体空闲时间的这种方案。

缺点：发生冲突后还是要坚持把数据帧发送完，造成了浪费。

##### ==CSMA/CD协议==

<font color='blue'>载波监听多点接入/碰撞检测CSMA/CD (carrier sense multiple access with collision detection)</font>

**CS**:载波侦听/监听，每一个站在发送数据之前以及发送数据时都要检测一下总线上是否有其他计算机在发送数据

**MA**:多点接入，表示许多计算机以多点接入的方式连接在一根总线上。

**CD**:碰撞检测（冲突检测），“边发送边监听”，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。

==适用于：半双工网络,总线型网络==

###### 传播时延会导致冲突

争用期/冲突窗口/碰撞窗口：总线的端到端往返传播时延

只要经过==$2\tau$==时间还没有检测到碰撞，就能肯定这次发送不会发生碰撞。

###### 冲突后的重传时机

1. 确定基本退避(推迟）时间为争用期2r。
2. 定义参数**k**，它等于**重传次数**，但k不超过10，即k=min[重传次数，10]。当重传次数不超过10时，k等于重传次数;当重传次数大于10时，k就不再增大而一直等于10。
3. 从离散的整数集合**[0,1,2^k^-1]**中随机取出一个数r，重传所需要退避的时间就是**r倍的基本退避时间**，即**$2r \tau$。**
4. 当重传达16次仍不能成功时，说明网络太拥挤，认为此帧永远无法正确发出，**抛弃此帧并向高层报告**出错。

###### 最小帧长问题

帧的传输时延至少要两倍于信号在总线中的传播时延。

<font color='red'>最小帧长=总线传播时延x数据传输速率x2</font>

**太网规定最短帧长为==64B==，凡是长度小于64B的都是由于冲突而异常终止的无效帧。**

##### CSMA/CA协议

<font color='blue'>载波监听多点接入/碰撞避免CSMA/CA (carrier sense multiple access with collision avoidance)</font>

**应用于无线局域网**

###### 工作原理

1. 发送数据前，先检测信道是否空闲。
2. 空闲则发出==RTS (request to send）==，RTS包括发射端的地址、接收端的地址、下一份数据将持续发送的时间等信息;信道忙则等待。
3. 接收端收到RTS后，将响应==CTS (clear to send）。==
4. 发送端收到CTS后，开始发送数据帧（同时==预约信道==:发送方告知其他站点自己要传多久数据）。
5. 接收端收到数据帧后，将用CRC来检验数据是否正确，正确则响应ACK帧。
6. 发送方收到ACK就可以进行下一个数据帧的发送，若没有则一直重传至规定重发次数为止(采用二进制指数退避算法来确定随机的推迟时间）。

###### CSMA/CA避免碰撞的方法

1. 预约信道
2. ACK帧
3. RTS/CTS（可选）

###### CSMA/CD vs CSMA/CA

<font color='red'>相同点:</font>

CSMA/CD与CSMA/CA机制都从属于CSMA的思路，其核心是先听再说。换言之，两个在接入信道之前都须要进行监听。当发现信道空闲后，才能进行接入。

<font color='green'>不同点:</font>

1. **传输介质不同**:CSMA/CD用于总线式以太网**【有线】**，而CSMA/CA用于无线局域网**【无线】**。
2. **载波检测方式不同**:因传输介质不同，CSMA/CD与CSMA/CA的检测方式也不同。CSMA/CD通过电缆中电压的变化来检测，当数据发生碰撞时，电缆中的电压就会随着发生变化;而CSMA/CA采用能量检测（ED)、载波检测(CS）和能量载波混合检测三种检测信道空闲的方式。
3. **CSMA/CD检测冲突，CSMA/CA避免冲突**，二者出现冲突后都会进行有上限的重传。

## 局域网

**局域网(Local Area Network):**简称LAN，是指在某一区域内由多台计算机互联成的计算机组使用**==广播信道==**。

- 特点1:**覆盖的地理范围较小**，只在一个相对独立的局部范围内联，如一座或集中的建筑群内。
- 特点2:使用专门铺设的传输介质（双绞线、同轴电缆）进行联网，**数据传输速率高**(10Mb/s～~10Gb/s）。
- 特点3:通信延迟时间短，误码率低，**可靠性较高**。
- 特点4:**各站为平等关系**，共享传输信道。
- 特点5:多**采用分布式控制和广播式通信**，能进行广播和组播。

决定局域网的主要要素为:**网络拓扑，传输介质与介质访问控制方法**。

### 局域网拓扑结构

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727155031806.png" alt="image-20210727155031806"  />

中心节点是控制中心，任意两个节点间的通信最多只需两步,传输速度快,并且网络构形简单、建网容易、便于控制和管理。但这种网络系统，网络可靠性低，网络共享能力差,有单点故障问题。

![image-20210727155154650](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727155154650.png)

网络可靠性高、网络节点间响应速度快、共享资源能力强、设备投入量少、成本低、安装使用方便,当某个工作站节点出现故障时,对整个网络系统影响小。

![image-20210727155235224](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727155235224.png)

系统中通信设备和线路比较节省。有单点故障问题;由于环路是封闭的,所以不便于扩充，系统响应延时长，且信息传输效率相对较低。

![image-20210727155326222](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727155326222.png)

易于拓展，易于隔离故障,也容易有单点故障。

### 局域网介质访问控制方法

1.CSMA/CD	常用于==总线型局域网,也用于树型网络==

2.令牌总线 	常用于==总线型局域网，也用于树型网络==
	     						它是把总线型或树型网络中的各个工作站按一定顺序如按接口地址大小排列形成一个逻辑环。只有令牌								 持有者才能控制总线，才有发送信息的权力。

3.令牌环 		用于==环形局域网==，如令牌环网

### 局域网分类

1. 以太网	以太网是应用最为广泛的局域网，包括标准以==太网(10Mbps)、快速以太网（100Mbps)、千兆以太网（1000 Mbps）和10G以太网==，它们都符合==IEEE802.3==系列标准规范。逻辑拓扑总线型，物理拓扑是星型或拓展星型。使用CSMA/CD.
2. 令牌环网	物理上采用了星形拓扑结构，逻辑上是环形拓扑结构。已是“明日黄花”。
3. FDDI网(Fiber Distrlbuted Data Interface）	物理上采用了双环拓扑结构，逻辑上是环形拓扑结构。
4. ATM网（Asynchronous Transter Mode）	较新型的单元交换技术,使用53字节固定长度的单元进行交换。
5. 无线局域网(Wireless Local Area Network;WLAN）	采用==IEEE 802.11==标准。

> IEEE 802系列标准是IEEE 8O2 LAN/MAN标准委员会制定的局域网、城域网技术标准（1980年2月成立)。其中最广泛使用的有以太网、令牌环、无线局域网等。这一系列标准中的每一个子标准都由委员会中的一个专门工作组负责。
>
> <img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727155945086.png" alt="image-20210727155945086" style="zoom:80%;" />
>
> <img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727155953156.png" alt="image-20210727155953156" style="zoom:80%;" />
>
> <img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727160003194.png" alt="image-20210727160003194" style="zoom: 80%;" />
>
> <img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727160013404.png" alt="image-20210727160013404" style="zoom:80%;" />
>
> 

### MAC子层和LLC子层

IEEE 802标准所描述的==局域网参考模型==只对应OSI参考模型的<font color='red'>数据链路层与物理层</font>，它将数据链路层划分为逻辑链路层LLC子层和介质访问控制MAC子层。

* ==LLC子层==负责识别网络层协议，然后对它们进行封装。LLC报头告诉数据链路层一旦帧被接收到时，应当对数据包做何处理。为网络层提供服务:无确认无连接、面向连接、带确认无连接、高速传送。

* ==MAC子层==的主要功能包括数据帧的封装/卸装，帧的寻址和识别，帧的接收与发送，链路的管理,帧的差错控制等。MAC子层的存在屏蔽了不同物理链路种类的差异性。

### 适配器与MAC地址

计算机与外界的有线局域网的连接是通过==通信适配器==的。

在局域网中，硬件地址又称为物理地址，或MAC地址。【实际上是标识符】

MAC地址:每个适配器有一个全球唯一的==48==位二进制地址，前24位代表厂家（由IEEE规定)，后24位厂家自己指定。常用6个十六进制数表示，如02-60-8c-e4-b1-21。

### 以太网

**以太网(Ethernet)**指的是由Xerox公司创建并由Xerox、Intel和DEC公司联合开发的==基带总线局域网规范==，是当今现有局域网采用的最通用的通信协议标准。以太网络使用**==<font color='red'>CSMA/CD</font>==**(载波监听多路访问及冲突检测）技术。

以太网在局域网各种技术中占统治性地位:

1. 造价低廉（以太网网卡不到100块）;
2. 是应用最广泛的局域网技术;
3. 比令牌环网、ATM网便宜，简单;
4. 满足网络速率要求:10Mb/s~10Gb/s.

以太网的两个标准：

- DIX Ethernet V2:第一个局域网产品（以太网）规约。==以太网==
- IEEE 802.3:IEEE 802委员会802.3工作组制定的第一个IEEE的以太网标准。(帧格式有一丢丢改动) 	==802.3局域网==

#### 无连接、不可靠服务

无连接:发送方和接收方之间无“握手过程”。

不可靠:不对发送方的数据帧**编号**，接收方不向发送方进行**确认**，差错帧直接丢弃，差错纠正由高层负责。

​														<font color='red'>以太网只实现无差错接收,不实现可靠传输。</font>

==以太网拓扑:逻辑上总线型，物理上星型。==

#### 10Base-T以太网

10BASE-T是传送==基带信号==的双绞线以太网，T表示采用双绞线，现10BASE-T采用的是==无屏蔽双绞线(UTP)==，传输速率是==10Mb/s==。

> “10”代表10Mb/s 	“Base”代表基带信号 	“T”代表双绞线

- 物理上==采用星型拓扑，逻辑上总线型==，每段双绞线==最长为100m。==
- 采用==曼彻斯特编码==。
- 采用==CSMA/CD==介质访问控制。

#### 以太网的MAC帧

最常用的MAC帧是以太网V2的格式。（DIX Ethernet V2）

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727162653213.png" alt="image-20210727162653213" style="zoom: 80%;" />

<font color='red'>最小帧长为64B，最大帧长为1518B</font>

与IEEE 802.3的区别:

- 第三个字段是长度/类型
- 当长度/类型字段值小于0x0600时，数据字段必须装入LLC子层。

#### 高速以太网

1.100BASE-T以太网

在==双绞线==上传送==100Mb/s==基带信号的星型拓扑以太网，仍使用IEEE802.3的CSMA/CD协议。支持==全双工和半双工==，可在==全双工方式下工作而无冲突==。

2.吉比特以太网

在==光纤或双绞线==上传送==1Gb/s==信号。支持==全双工和半双工==，可在==全双工方式下工作而无冲突==。

3.10吉比特

10吉比特以太网在==光纤==上传送==10Gb/s==信号。只支持==全双工==，==无争用问题==。

### IEEE 802.11无线局域网

IEEE 802.11是**无线局域网**通用的标准，它是由IEEE所定义的无线网络通信的标准。

#### 802.11的MAC帧头格式

![image-20211106152240198](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211106152240198.png)

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727163633929.png" alt="image-20210727163633929" style="zoom: 65%;" />

#### 有固定基础设施无线局域网

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727163745266.png" alt="image-20210727163745266" style="zoom: 63%;" />

#### 无固定基础设施无线局域网的自组织网络

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727163853546.png" alt="image-20210727163853546" style="zoom: 60%;" />

## VLAN的基本概念和原理

### 传统局域网的限制

* 缺乏流量隔离:即使把组流量局域化道一个单一交换机中，广播流量仍会跨越整个机构网络(ARP、RIP、DHCP协议)
* 管理用户不便:如果一个主机在不同组间移动，必须改变物理布线，连接到新的交换机上。
* 路由器成本较高:局域网内使用很多路由器花销较大。

### VLAN的基本概念

==虚拟局域网VLAN (Virtual Local Area Network)==是一种<font color='blue'>将局域网内的设备划分成与物理位置无关的逻辑组</font>的技术，这些逻辑组有某些共同的需求。每个VLAN是一个单独的广播域/不同的子网。

虚拟网络建立在网络交换机之上，它以==软件方式==来实现逻辑工作组的划分与管理

### VLAN的实现

#### 基于接口的VLAN技术

交换机上生成的各VLAN互不相通，若想实现通信，需要借助:==路由器或三层交换机==

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127145413811.png" alt="image-20211127145413811" style="zoom:80%;" />

#### 基于MAC地址的VLAN技术

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127145511483.png" alt="image-20211127145511483" style="zoom:80%;" />

------

### IEEE802.1Q帧

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127145647450.png" alt="image-20211127145647450" style="zoom:80%;" />

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20211127145709048.png" alt="image-20211127145709048" style="zoom:80%;" />

VLAN标记的前两个字节表明是IEEE 802.1Q帧，接下来4位没用，==后面12位是VLAN标识符VID==,唯一表示了该以太网帧属于哪个VLAN。

* VID的取值范围为0\~4095，但0和4095都不用来表示VLAN，因此用于==表示VLAN的有效VID取值范围为1~4094==。
* IEEE 802.1Q帧是由交换机来处理的，而不是由用户主机来处理的。(==即主机和交换机之间只交换普通的以太网帧==)

## PPP协议和HDLC协议

### 广域网

**广域网（WAN，Wide Area Network)**，通常跨接很大的物理范围，所覆盖的范围从几十公里到几千公里，它能连接多个城市或国家，或横跨几个洲并能提供远距离通信，形成国际性的远程网络。

广域网的通信子网主要使用**<font color='red'>分组交换技术</font>**。广域网的通信子网可以利用公用分组交换网、卫星通信网和无线分组交换网，它将分布在不同地区的**局域网或计算机系统**互连起来，达到<font color='red'>资源共享</font>的目的。==如因特网（Internet)是世界范围内最大的广域网。==

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727164314733.png" alt="image-20210727164314733" style="zoom:80%;" />

### PPP协议

#### PPP协议的特点

点对点协议PPP(Point-to-Point Protocol）是目前使用最广泛的数据链路层协议，用户使用拨号电话接入因特网时一般都使用PPP协议。

<font color='red' size=5>只支持全双工链路</font>

#### PPP协议需满足的要求

- **简单**	对于链路层的帧，无需纠错，无需序号，无需流量控制。
- **封装成帧**	帧定界符
- **透明传输**	与帧定界符一样比特组合的数据应该如何处理:==异步线路用字节填充，同步线路用比特填充。==
- **多种网络层协议**	封装的IP数据报可以采用多种协议。
- **多种类型链路**	串行/并行，同步/异步，电/光....
- **差错检测**	错就丢弃。
- **检测连接状**	态链路是否正常工作。
- **最大传送单元**	数据部分最大长度MTU。
- **网络层地址协商**	知道通信双方的网络层地址。
- **数据压缩协商**

#### PPP协议无需满足的要求

- **纠错**
- **流量控制**
- **序号**
- **不支持多点线路**

#### PPP协议的三个组成部分

1. 一个将IP数据报封装到串行链路（同步串行/异步串行)的方法。
2. 链路控制协议LCP:建立并维护数据链路连接。==身份验证==
3. 网络控制协议NCP: PPP可支持多种网络层协议，每个不同的网络层协议都要一个相应的NCP来配置，为网络层协议建立和配置逻辑连接。

#### PPP协议的状态图

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727170054071.png" alt="image-20210727170054071" style="zoom:80%;" />

#### PPP协议的帧格式

![image-20210727170509193](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727170509193.png)

###  ~~HDLC协议~~

**高级数据链路控制(High-Level Data Link Control或简称HDLC)**，是一个在同步网上传输数据、==面向比特==的数据链路层协议，它是由国际标准化组织(==ISO==)根据IBM公司的SDLC(SynchronousData Link Control)协议扩展开发而成的.

数据报文可透明传输，用于实现透明传输的“0比特插入法”易于硬件实现

<font color='red'>采用全双工通信</font>

所有帧采用**CRC检验**，对信息帧进行顺序**编号**，可防止漏收或重份，传输可靠性高。

#### ~~HDLC的站~~

**<font color='blue' size='4'>主站、从站、复合站</font>**

- 主站的主要功能是发送命令（包括数据信息）帧、接收响应帧，并负责对整个链路的控制系统的初启、流程的控制、差错检测或恢复等。
- 从站的主要功能是接收由主站发来的命令帧，向主站发送响应帧，并且配合主站参与差错恢复等链路控制。
- 复合站的主要功能是既能发送，又能接收命令帧和响应帧，并且负责整个链路的控制。

<font color='blue'>三种数据操作方式:</font>

1. 正常响应方式
2. 异步平衡方式
3. 异步响应方式

#### ~~HDLC的帧格式~~

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727171651605.png" alt="image-20210727171651605" style="zoom:67%;" />

帧的类型：

- ==信息帧(I）==第1位为0，用来传输数据信息，或使用捎带技术对数据进行确认;
- ==监督帧(S）==10，用于流量控制和差错控制，执行对信息帧的确认、请求重发和请求暂停发送等功能
- ==无编号帧(U)==11，用于提供对链路的建立、拆除等多种控制功能。

### ~~PPP协议＆HDLC协议~~

相同点：

- HDLC、PPP只支持全双工链路。
- 都可以实现透明传输。
- 都可以实现差错检测，但不纠正差错。

不同点：

| PPP协议      | 面向字节     | 2B协议字段 | 无序号和确认机制     | 不可靠   |      |
| ------------ | ------------ | ---------- | -------------------- | -------- | ---- |
| **HDLC协议** | **面向比特** | **没有**   | **有编号和确认机制** | **可靠** |      |

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210727172256344.png" alt="image-20210727172256344" style="zoom:80%;" />

## 数据链路层的设备

### ~~网桥~~

==网桥==根据MAC帧的目的地址对帧进行**转发和过滤**。当网桥收到一个帧时，并不向所有接口转发此帧，而是先检查此帧的目的MAC地址，然后再确定将该帧转发到哪一个接口，或者是把它丢弃（即过滤）。

![image-20210805172608934](C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805172608934.png)

> **网段:一般指一个计算机网络中使用同一物理层设备(传输介质，中继器，集线器等)能够直接通讯的那一部分。**

网桥优点:

- 过滤通信量，增大吞吐量。
- 扩大了物理范围。
- 提高了可靠性。
- 可互连不同物理层、不同MAC子层和不同速率的以太网。

#### ~~透明网桥~~

**==透明网桥==**:“透明”指以太网上的站点并不知道所发送的帧将经过哪几个网桥，是一种即插即用设备―自学习。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805172912737.png" alt="image-20210805172912737" style="zoom:80%;" />

#### ~~源路由网桥~~

**==源路由网桥:==**在发送帧时，把详细的最佳路由信息（路由最少/时间最短）放在帧的首部中

方法:源站以广播方式向欲通信的目的站发送一个发现帧。

### 交换机

直通式交换机：查完目的地址（6B）就立刻转发。延迟小，可靠性低，无法支持具有不同速率的端口的交换。

存储转发式交换机：将帧放入高速缓存，并检查否正确，正确则转发，错误则丢弃。延迟大，可靠性高，可以支持具有不同速率的端口的交换

### 冲突域和广播域

==冲突域==:在同一个冲突域中的每一个节点都能收到所有被发送的帧。简单的说就是同一时间内只能有一台设备发送信息的范围。

==广播域==:网络中能接收任一设备发出的广播帧的所有设备的集合。简单的说如果站点发出一个广播信号，所有能接收收到这个信号的设备范围称为一个广播域。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210805181059906.png" alt="image-20210805181059906" style="zoom: 80%;" />

