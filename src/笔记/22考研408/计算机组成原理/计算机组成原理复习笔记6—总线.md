# 总线

## 概述

简朴图：<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210909213856423.png" alt="image-20210909213856423" style="zoom:80%;" />

==每个总线可能由很多根信号线组成==

同一时刻**只能有一个部件发送数据**，但是**可有多个部件接受数据**

### 定义

**总线是一组能为多个部件<font color='red'>分时</font><font color='blue'>共享</font>的公共信息传送线路。**

> **共享**是指总线上可以挂接多个部件，各个部件之间互相交换的信息都可以通过这组线路分时共享。
>
> **分时**是指同一时刻只允许有一个部件向总线发送信息，如果系统中有多个部件，则它们只能分时地向总线发送信息。

### 特性

1. 机械特性:尺寸、形状、管脚数、排列顺序
2. 电气特性:传输方向和有效的电平范围
3. 功能特性:每根传输线的功能(地址、数据、控制)
4. 时间特性:信号的时序关系

### 分类

#### 按数据传输格式

##### 串行总线

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210909214423403.png" alt="image-20210909214423403" style="zoom:80%;" />

- **优点**:只需要一条传输线，成本低廉，广泛应用于长距离传输;应用于计算机内部时，可以节省布线空间。
- **缺点**:在数据发送和接收的时候要进行拆卸和装配，要考虑**串行-并行转换**的问题。

##### 并行总线

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210909214515270.png" alt="image-20210909214515270" style="zoom:80%;" />

- **优点**:总线的逻辑时序比较简单,电路实现起来比较容易。
- **缺点**:信号线数量多，占用更多的布线空间;远距离传输成本高昂;由于工作频率较高时，并行的信号线之间会产生严重干扰,对每条线等长的要求也越高，所以无法持续提升工作频率。

#### 按总线功能（连接的部件）

##### 片内总线

片内总线是芯片内部的总线。
它是CPU芯片内部寄存器与寄存器之间、寄存器与ALU之间的公共连接线。

##### 系统总线

系统总线是计算机系统内各功能部件（CPU、主存、I/O接口）之间相互连接的总线。

按系统总线传输信息内容的不同，又可分为3类:**<font color='blue'>数据总线</font>、<font color='brown'>地址总线</font>和<font color='green'>控制总线</font>。**

1. 数据总线用来传输各功能部件之间的数据信息，它是双向传输总线，其位数与==机器字长、存储字长==有关。
2. 地址总线用来指出数据总线上的源数据或目的数据所在的主存单元或I/O端口的地址，它是单向传输总线，地址总线的位数与==主存地址空间的大小有关==。
3. 控制总线传输的是控制信息，包括CPU送出的控制命令和主存(或外设）返回CPU的反馈信号。

##### 通信总线

通信总线是用于计算机系统之间或计算机系统与其他系统（如远程通信设备、测试设备)之间信息传送的总线,通信总线也称为外部总线。

#### 按时序控制方式

##### 同步总线

##### 异步总线

### 总线的结构

#### 单总线结构

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910203713638.png" alt="image-20210910203713638" style="zoom:80%;" />

> 注:单总线并不是指只有一根信号线，系统总线按传送信息的不同可以细分为地址总线、数据总线和控制总线。

结构:CPU、主存、IO设备（通过I/O接口）都连接在一组总线上，允许I/O设备之间、O设备和CPU之间或IO设备与主存之间直接交换信息。

- 优点:结构简单，成本低，易于接入新的设备。
- 缺点:带宽低、负载重，多个部件只能争用唯一的总线，且不支持并发传送操作。

#### 双总线结构

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910203843911.png" alt="image-20210910203843911" style="zoom:80%;" />

> ==突发(猝发)传送:送出一个地址,收到多个地址连续的数据。==
>
> 通道是具有特殊功能的处理器,能对I/O设备进行统一管理。通道程序放在主存中。

结构:双总线结构有两条总线，一条是主存总线，用于CPU、主存和通道之间进行数据传送;另一条是I/O总线，用于多个外部设备与通道之间进行数据传送。

- 优点:将较低速的I/O设备从单总线上分离出来，**==实现存储器总线和I/O总线分离==。**
- 缺点:需要增加通道等硬件设备。

#### 三总线结构

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910204052655.png" alt="image-20210910204052655" style="zoom:80%;" />

> DMA: Direct Memory Access,直接内存访问。

结构:三总线结构是在计算机系统各部件之间采用3条各自独立的总线来构成信息通路,这3条总线分别为主存总线、I/O总线和直接内存访问DMA总线。

- 优点:提高了I/O设备的性能，使其更快地响应命令，提高系统吞吐量。
- 缺点:系统工作效率较低。

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910204232726.png" alt="image-20210910204232726" style="zoom:80%;" />

## 性能指标

1. 总线的传输周期(总线周期)
   一次总线操作所需的时间(**包括申请阶段、寻址阶段、传输阶段和结束阶段**)，通常由若**干个总线时钟周期**构成。
2. 总线时钟周期
   即机器的时钟周期。计算机有一个统一的时钟，以控制整个计算机的各个部件，总线也要受此时钟的控制。
3. 总线的工作频率
   总线上各种操作的频率，为总线周期的倒数。实际上指一秒内传送几次数据。
4. 总线的时钟频率
   即机器的时钟频率，为时钟周期的倒数。实际上指一秒内有多少个时钟周期。
5. 总线宽度
   又称为总线位宽，它是总线上同时能够传输的数据位数，通常是指数据总线的根数
   如32根称为32位（bit)总线。
6. 总线带宽
   可理解为总线的数据传输率，即单位时间内总线上可传输数据的位数，通常用每秒钟传送信息的字节数来衡量，单位可用字节/秒(B/s）表示。
   <font color='red'>**$总线带宽=总线工作频率×总线宽度（bit/s）=总线工作频率×(总线宽度/8)(B/s）$**</font>
7. 总线复用
   总线复用是指**一种信号线在不同的时间传输不同的信息**。可以使用较少的线传输更多的信息，从而节省了空间和成本。
8. 信号线数
   地址总线、数据总线和控制总线3种总线数的总和称为信号线数。

## ~~==仲裁==~~

同一时刻只能**有一个设备控制**总线**传输**操作，可以有**一个或多个设备**从总线**接收**数据。

将总线上所连接的各类设备按其对总线有无控制功能分为:

- 主设备:获得总线控制权的设备。
- 从设备:被主设备访问的设备，只能响应从主设备发来的各种总线命令。

**总线仲裁的定义:多个主设备同时竞争主线控制权时，以某种方式选择一个主设备优先获得总线控制权称为总线仲裁。**

总线仲裁分类:

- 集中仲裁方式：
  - 链式查询方式
  - 计数器定时查询方式
  - 独立请求方式
- 分布仲裁方式

### ~~集中仲裁方式~~

工作流程:

1. 主设备发出请求信号;
2. 若多个主设备同时要使用总线，则由总线控制器的判优、仲裁逻辑按一定的优先等级顺序确定哪个主设备能使用总线;
3. 获得总线使用权的主设备开始传送数据。

#### ~~链式查询方式~~

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910205031944.png" alt="image-20210910205031944" style="zoom:80%;" />

> **==“总线忙”信号的建立者是获得总线控制权的设备==**

优先级:
离总线控制器越**近**的部件,其优先级**越高;**
离总线控制器越**远**的部件,其优先级**越低。**

- 优点:链式查询方式优先级固定。只需很少几根控制线就能按一定优先次序实现总线控制，结构简单，扩充容易。
- 缺点:对硬件电路的故障敏感，并且优先级不能改变。当优先级高的部件频繁请求使用总线时，会使优先级较低的部件长期不能使用总线。

#### ~~计数器定时查询方式~~

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910205424701.png" alt="image-20210910205424701" style="zoom:80%;" />

结构特点:用一个计数器控制总线使用权，相对链式查询方式**多了一组设备地址线**，**少了一根总线响应线BG**;它仍共用一根总线请求线。

**当地址线上的计数值与请求使用总线设备的地址一致时,该设备获得总线控制权。同时，中止计数器的计数及查询。**

**当总线控制器收到总线请求信号，判断总线空闲时，计数器开始计数，计数值通过设备地址线发向各个部件。**

- 优点:
  1. 计数初始值可以改变优先次序
     -计数每次从“0”开始，设备的优先级就按顺序排列，固定不变;
     -计数从上一次的终点开始，此时设备使用总线的优先级相等;
     -计数器的初值还可以由程序设置
  2. 对电路的故障没有链式敏感
- 缺点:
  1. 增加了控制线数
     -若设备有n个，则需log~2~n+2条控制线
  2. 控制相对比链式查询相对复杂

#### ~~独立请求方式~~

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910210053602.png" alt="image-20210910210053602" style="zoom:80%;" />

结构特点:每一个设备均有一对总线请求线BR~i~和总线允许线BG~i~

**当总线控制器按一定的优先次序决定批准某个部件的请求时,则给该部件发送总线响应信号。**

**当总线上的部件需要使用总线时，经各自的总线请求线发送总线请求信号，在总线控制器中排队。**

优点:

1. 响应速度快，总线允许信号BG直接从控制器发送到有关设备，不必在设备间传递或者查询。
2. 对优先次序的控制相当灵活。

缺点:

1. 控制线数量多
   -若设备有n个，则需要2n+1条控制线。
   **其中+1为BS线，用于设备向总线控制部件反馈已经是否正在使用总线。**
2. 总线的控制逻辑更加复杂

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910210404176.png" alt="image-20210910210404176" style="zoom:80%;" />

### ~~分布仲裁方式~~

**特点**:不需要中央仲裁器，每个潜在的主模块都有自己的仲裁器和仲裁号，多个仲裁器竞争使用总线。

- 当设备有总线请求时，它们就把各自唯一的仲裁号发送到共享的仲裁总线上;
- 每个仲裁器将从仲裁总线上得到的仲裁号与自己的仲裁号进行比较;
- 如果仲裁总线上的号优先级高，则它的总线请求不予响应，并撤销它的仲裁号;
- 最后，获胜者的仲裁号保留在仲裁总线上。

## ==操作和定时==

### 总线周期的四个阶段

1. **申请分配阶段**:由需要使用总线的主模块（或主设备）提出申请，经总线仲裁机构决定将下一传输周期的总线使用权授予某一申请者。也可将此阶段细分为==传输请求==和==总线仲裁==两个阶段。
2. **寻址阶段**:获得使用权的主模块通过总线发出本次要访问的从模块的地址及有关命令，**启动**参与本次传输的**从模块**。
3. **传输阶段**:主模块和从模块进行**数据交换**，可**单向或双向**进行数据传送。
4. **结束阶段**:主模块的有关信息均从系统总线上**撤除**，**让出**总线使用权。

**==总线定时==**是指总线在双方交换数据的过程中需要时间上配合关系的控制，这种控制称为总线定时，它的实
质是一种协议或规则

### 同步定时方式

**总线控制器采用一个统一的时钟信号来协调发送和接收双方的传送定时关系。**

读命令：

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910210735340.png" alt="image-20210910210735340" style="zoom:80%;" />

1. CPU在T1时刻的上升沿给出地址信息
2. 在T2的上升沿给出读命令(低电平有效），与地址信息相符合的输入设备按命令进行一系列的内部操作,且必须在T3的上升沿来之前将CPU所需的数据送到数据总线上。
3. CPU在T3时钟周期内，将数据线上的信息传送到其内部寄存器中。
4. CPU在T4的上升沿撤销读命令，输入设备不再向数据总线上传送数据，撤销它对数据总线的驱动。

**同步定时方式**是指系统采用一个统一的时钟信号来协调发送和接收双方的传送定时关系。

若干个时钟产生相等的时间间隔，每个间隔构成一个总线周期。

在一个总线周期中,发送方和接收方可进行**一次数据**传送。

因为采用统一的时钟，每个部件或设备发送或接收信息都在固定的总线传送周期中个总线的传送周期结束，下一个总线传送周期开始。

- **优点:传送速度快，具有较高的传输速率;总线控制逻辑简单。**
- **缺点:主从设备属于强制性同步;不能及时进行数据通信的有效性检验，可靠性较差。**

==同步通信适用于**总线长度较短**及**总线所接部件的存取时间比较接近**的系统。==

### 异步定时方式

在异步定时方式中，没有统一的时钟，也没有固定的时间间隔，完全依靠传送双方相互制约的**“握手”信号来实现定时控制。**

主设备提出交换信息的“请求”信号，经接口传送到从设备;从设备接到主设备的请求后，通过接口向主设备发出“回答”信号。

#### 不互锁方式（速度快，可靠性差）

主设备发出“请求”信号后，不必等到接到从设备的“回答”信号，而是经过一段时间，便撤销“请求”信号。

而从设备在接到“请求”信号后，发出“回答”信号，并经过一段时间,自动撤销“回答”信号。双方不存在互锁关系。

#### 半互锁方式

主设备发出“请求”信号后，必须待接到从设备的“回答”信号后，才撤销“请求”信号，有互锁的关系。

而从设备在接到“请求”信号后，发出“回答”信号，但不必等待获知主设备的“请求”信号已经撤销，而是隔一段时间后自动撤销“回答”信号，不存在互锁关系。

#### 全互锁方式（最可靠，速度最慢）

主设备发出“请求”信号后，必须待从设备“回答”后，才撤销“请求”信号;

从设备发出“回答”信号，必须待获知主设备“请求”信号已撤销后，再撤销其“回答”信号。双方存在互锁关系。



- 优点:总线周期长度可变，能保证两个工作速度相差很大的部件或设备之间可靠地进行信息交换，自动适应时间的配合。
- 缺点:比同步控制方式稍复杂一些，速度比同步定时方式慢。

### 半同步通信

半同步通信:统一时钟的基础上，增加一个“等待”响应信号WAIT

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910211554965.png" alt="image-20210910211554965" style="zoom:80%;" />

### 分离式通信

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910211634793.png" alt="image-20210910211634793" style="zoom:80%;" />

分离式通信的一个总线传输周期

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910211653821.png" alt="image-20210910211653821" style="zoom:80%;" />

特点:

1. 各模块均有权申请占用总线
2. 采用同步方式通信,不等对方回答
3. 各模块准备数据时，不占用总线
4. 总线利用率提高

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910211742581.png" alt="image-20210910211742581" style="zoom:80%;" />

## ~~总线标准~~

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910211816823.png" alt="image-20210910211816823" style="zoom:80%;" />

<img src="C:\Users\LIMBO\AppData\Roaming\Typora\typora-user-images\image-20210910211834476.png" alt="image-20210910211834476" style="zoom:80%;" />

